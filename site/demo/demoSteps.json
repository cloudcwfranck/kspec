{
  "$schema": "./demoStepsSchema.json",
  "version": "1.0.0",
  "prompt": "(kind-kspec) franck@csengineering$",
  "tabs": [
    {
      "id": "scan",
      "label": "Scan",
      "description": "Pain: \"I don't know what's wrong\" → Fix: Automated security & compliance scanning",
      "steps": [
        {
          "command": "kubectl config current-context",
          "output": "kind-kspec"
        },
        {
          "command": "kspec scan --spec specs/examples/strict.yaml --format table",
          "output": "⠿ Loading spec: specs/examples/strict.yaml\n✓ Connected to cluster: kind-kspec\n✓ Analyzing 23 pods across 5 namespaces\n\n┌─────────────────────────────────┬────────┬──────────┬─────────────────────┐\n│ Check                           │ Status │ Severity │ Details             │\n├─────────────────────────────────┼────────┼──────────┼─────────────────────┤\n│ pod-security-baseline           │ PASS   │ high     │ 23/23 pods compliant│\n│ no-privileged-containers        │ FAIL   │ critical │ 2/23 pods failing   │\n│ require-resource-limits         │ FAIL   │ medium   │ 8/23 pods failing   │\n│ network-policy-required         │ PASS   │ high     │ 5/5 namespaces ok   │\n│ restrict-hostpath-volumes       │ PASS   │ high     │ 23/23 pods compliant│\n│ require-non-root-user           │ FAIL   │ medium   │ 3/23 pods failing   │\n└─────────────────────────────────┴────────┴──────────┴─────────────────────┘\n\nSummary:\n  Passed: 3/6 checks (50.0%)\n  Failed: 3/6 checks\n  \n  Critical issues: 1\n  High issues: 0\n  Medium issues: 2\n\nRecommendation: Run 'kspec enforce' to auto-generate policies"
        },
        {
          "command": "kspec report --last --format sarif",
          "output": "✓ Generating SARIF 2.1.0 report from last scan\n✓ Writing to kspec-report-20260103.sarif.json\n\nReport summary:\n  • Total findings: 13\n  • Critical: 2 (privileged containers in default/admin-pod, kube-system/debug)\n  • High: 0\n  • Medium: 11 (missing resource limits, non-root user violations)\n\nUpload to GitHub Code Scanning:\n  gh api repos/cloudcwfranck/kspec/code-scanning/sarifs \\\n    -F sarif=@kspec-report-20260103.sarif.json"
        }
      ],
      "docsLink": "https://github.com/cloudcwfranck/kspec#quick-start"
    },
    {
      "id": "enforce",
      "label": "Enforce",
      "description": "Pain: \"I need guardrails, not a manual checklist\" → Fix: Automated policy generation & enforcement",
      "steps": [
        {
          "command": "kspec enforce --spec specs/examples/strict.yaml --mode enforce",
          "output": "⠿ Loading spec: specs/examples/strict.yaml\n✓ Validating policy definitions\n✓ Connecting to cluster: kind-kspec\n\nGenerating Kyverno policies:\n  → kspec-psa-baseline (pod security standards)\n  → kspec-no-privileged (block privileged containers)\n  → kspec-require-limits (enforce CPU/memory limits)\n  → kspec-non-root-user (require non-root execution)\n\n⠿ Creating ClusterPolicies...\n✓ kspec-psa-baseline created\n✓ kspec-no-privileged created\n✓ kspec-require-limits created\n✓ kspec-non-root-user created\n\n✓ Admission webhooks configured\n✓ Policies are now enforcing\n\nEnforcement active! New pods will be validated against these policies."
        },
        {
          "command": "kubectl get clusterpolicy | grep kspec",
          "output": "kspec-non-root-user      Enforce    Background,Validate   Ready   12s\nkspec-no-privileged      Enforce    Background,Validate   Ready   12s\nkspec-psa-baseline       Enforce    Background,Validate   Ready   13s\nkspec-require-limits     Enforce    Background,Validate   Ready   12s"
        },
        {
          "command": "kubectl run test --image=nginx --privileged=true",
          "output": "Error from server: admission webhook \"validate.kyverno.svc-fail\" denied the request: \n\nresource Pod/default/test was blocked due to the following policies\n\nkspec-no-privileged:\n  no-privileged-containers: validation error: Privileged containers are not allowed.\n  Spec.containers[0].securityContext.privileged must be false or undefined.\n  \n✗ Policy enforcement working as expected!"
        }
      ],
      "docsLink": "https://github.com/cloudcwfranck/kspec/blob/main/docs/API_REFERENCE.md"
    },
    {
      "id": "drift",
      "label": "Drift Detection",
      "description": "Pain: \"We were compliant last week... now we aren't\" → Fix: Continuous drift detection & remediation",
      "steps": [
        {
          "command": "kspec drift detect --spec specs/examples/strict.yaml",
          "output": "⠿ Loading spec: specs/examples/strict.yaml\n⠿ Comparing cluster state to desired configuration...\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n⚠ Drift Detected\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nPolicy: kspec-no-privileged\n  Status: MODIFIED\n  Change: spec.rules[0].validate.message was changed\n  \n  - \"Privileged containers are not allowed\"\n  + \"[CUSTOM] No privileged pods allowed\"\n  \n  Last modified: 2 hours ago\n  Modified by: user@example.com\n\nPolicy: kspec-require-limits\n  Status: DELETED\n  Last seen: 45 minutes ago\n  Impact: Resource limit enforcement is now DISABLED\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nSummary:\n  Drifted policies: 2\n  Security impact: HIGH (missing resource limits)\n  \nRecommended action:\n  kspec drift remediate --spec specs/examples/strict.yaml"
        },
        {
          "command": "kspec drift remediate --spec specs/examples/strict.yaml --dry-run",
          "output": "⠿ Dry-run mode (no changes will be applied)\n\nPlanned actions:\n  1. Restore policy: kspec-require-limits\n     Action: Re-create from spec\n     \n  2. Revert policy: kspec-no-privileged\n     Action: Reset validation message to original value\n     \nTo apply these changes, run:\n  kspec drift remediate --spec specs/examples/strict.yaml"
        },
        {
          "command": "kspec drift remediate --spec specs/examples/strict.yaml",
          "output": "⠿ Remediating drift...\n\n→ Restoring kspec-require-limits\n  ✓ Policy re-created from spec\n  ✓ Admission webhook updated\n  \n→ Reverting kspec-no-privileged\n  ✓ Validation message restored\n  ✓ Policy hash updated\n  \n✓ Drift remediation complete!\n✓ Cluster is now compliant with specs/examples/strict.yaml\n\nNext: Set up monitoring with 'kspec drift watch' to detect future drift"
        }
      ],
      "docsLink": "https://github.com/cloudcwfranck/kspec/blob/main/docs/DRIFT_DETECTION.md"
    },
    {
      "id": "reports",
      "label": "Reports",
      "description": "Pain: \"Auditors want proof\" → Fix: Export evidence in standard formats (OSCAL, SARIF, Markdown)",
      "steps": [
        {
          "command": "kspec report --last --format oscal --output /tmp/oscal.json",
          "output": "⠿ Generating OSCAL assessment report\n✓ Loading compliance framework: NIST 800-53 rev5\n✓ Mapping kspec findings to controls\n✓ Analyzing 23 resources across 5 namespaces\n\nWritten to: /tmp/oscal.json\n\nReport statistics:\n  Controls assessed: 47\n  Controls satisfied: 32 (68.1%)\n  Controls partially-satisfied: 11 (23.4%)\n  Controls not-satisfied: 4 (8.5%)\n  \n  Lines: 1,847\n  Size: 94.3 KB"
        },
        {
          "command": "kspec report --last --format markdown",
          "output": "# kspec Compliance Report\n**Generated:** 2026-01-03 14:32:17 UTC  \n**Cluster:** kind-kspec  \n**Spec:** specs/examples/strict.yaml\n\n## Executive Summary\n- **Overall Compliance:** 68.1%\n- **Critical Issues:** 2\n- **High Issues:** 0\n- **Medium Issues:** 11\n\n## Findings\n\n### Critical\n1. **Privileged containers detected**\n   - Resource: default/admin-pod\n   - Policy: kspec-no-privileged\n   - Recommendation: Remove securityContext.privileged=true\n   \n2. **Privileged container in system namespace**\n   - Resource: kube-system/debug\n   - Policy: kspec-no-privileged\n   - Recommendation: Use non-privileged debugging alternatives\n\n### Medium\n3-13. **Missing resource limits** (8 pods)\n   - Policy: kspec-require-limits\n   - Recommendation: Add requests/limits for CPU and memory\n\n---\n✓ Report saved to: kspec-compliance-20260103.md"
        }
      ],
      "docsLink": "https://github.com/cloudcwfranck/kspec/blob/main/docs/API_REFERENCE.md#reporting"
    },
    {
      "id": "metrics",
      "label": "Metrics",
      "description": "Pain: \"I need to monitor this continuously\" → Fix: Prometheus metrics + Grafana dashboards",
      "steps": [
        {
          "command": "kubectl -n kspec-system port-forward svc/kspec-metrics 9090:9090 &",
          "output": "[1] 28471\nForwarding from 127.0.0.1:9090 -> 9090\nForwarding from [::1]:9090 -> 9090"
        },
        {
          "command": "curl -s http://localhost:9090/metrics | grep kspec_",
          "output": "# HELP kspec_compliance_score Current compliance score (0-100)\n# TYPE kspec_compliance_score gauge\nkspec_compliance_score{cluster=\"kind-kspec\",spec=\"strict\"} 68.1\n\n# HELP kspec_drift_detected_total Total number of drifted policies\n# TYPE kspec_drift_detected_total counter\nkspec_drift_detected_total{cluster=\"kind-kspec\"} 2\n\n# HELP kspec_policy_violations Number of policy violations by severity\n# TYPE kspec_policy_violations gauge\nkspec_policy_violations{severity=\"critical\"} 2\nkspec_policy_violations{severity=\"high\"} 0\nkspec_policy_violations{severity=\"medium\"} 11\n\n# HELP kspec_scan_duration_seconds Time to complete compliance scan\n# TYPE kspec_scan_duration_seconds histogram\nkspec_scan_duration_seconds_bucket{le=\"1\"} 34\nkspec_scan_duration_seconds_bucket{le=\"5\"} 89\nkspec_scan_duration_seconds_bucket{le=\"10\"} 100"
        },
        {
          "command": "echo 'Grafana dashboard: http://localhost:3000/d/kspec-compliance'",
          "output": "Grafana dashboard: http://localhost:3000/d/kspec-compliance\n\nDashboard: kspec Compliance Monitoring\n\nPanels:\n  • Compliance Score Over Time (graph)\n  • Policy Violations by Severity (bar chart)  \n  • Drift Detection Events (table)\n  • Top Non-Compliant Resources (list)\n  • Scan Duration P95/P99 (stat)\n  \nAlerts:\n  ✓ compliance_below_threshold (triggers at <70%)\n  ✓ critical_violations_detected (triggers at >0)\n  ✓ drift_detected (Slack notification)\n\nView live metrics at http://localhost:3000"
        }
      ],
      "docsLink": "https://github.com/cloudcwfranck/kspec/blob/main/docs/WEBHOOKS.md"
    }
  ]
}
